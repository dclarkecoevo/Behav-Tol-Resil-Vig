---
title: "Behavioral Tolerance, Vigor, and resilience"
author: "David R. Clark, Jason Walsman, Rachael Kramp, and Jessica Stephenson"
date: "2024-03-25"
output:
  pdf_document:
    toc: yes
    number_sections: yes
  editor_options:
    chunk_output_type: console
  word_document:
    toc: yes
header-includes:
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Set so that long lines in R will be wrapped:
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=80), tidy=TRUE)
```

\section{Introduction}

\subsection{Overall summary}

\subsection{Quick experimental summary}

\subsection{Load in packages needed for analysis}

```{r packages and loading in dataset, message=FALSE, warning=FALSE}
#Clear the working environment
rm(list=ls())
#Visualization
library(ggplot2)
library(visreg)
source("http://highstat.com/Books/BGS/GAMM/RCodeP2/HighstatLibV6.R")
#(generalized) Linear mixed modeling
library(lme4)
library(glmmTMB)
library(lmodel2)
#Statistcal analysis reporting and model validation
library(performance)
library(car)
library(lmtest)
library(DHARMa)
#Data wrangling
library(dplyr)
library(plyr)
library(tidyverse)
library(tidylog)
library(splancs)

```

\subsection{Load in dataframe}

```{r load in data, warning=FALSE}

#Loading in data set
IndBehav<- read_csv("VIEBehavior_20210913_V2.csv", 
    col_types = cols(fishID = col_character(), 
         Infection = col_character(), InfDate = col_character(), 
         BehavGroup = col_character(), dayofinf = col_character(), 
         CountDay = col_character(), Behavdate = col_character(), 
         TOD = col_character(), Duration=col_double(),Velocity=col_double(),Distance=col_double()))

#Filtering Data set so we can perform our analysis
IndBehav1<-IndBehav %>%
  #Removing columns we dont need
  select(-c(Blind.ID, InfLength, dayofinf, Countintial, Notes, InfWeight))

#Quickly checking whether individuals have stress response from a new environment.

#Filter to only before measurements
IndBehav1_Before<- IndBehav1 %>%
  filter(TrialTime=="Before")


#plot the Activity by time of day

ggplot(IndBehav1_Before, aes(x=TOD, y=Velocity, fill=Sex))+
  geom_boxplot(aes(fill=Sex))+
  geom_jitter()+
  theme_classic()

#Quick Anova to verify that the difference is significantly different

anova(lm(Velocity~TOD*Sex, IndBehav1_Before))

#We do see a significant TOD effect so lets more specifically look at each individual
ggplot(IndBehav1_Before, aes(x=TOD, y=Velocity, color=fishID))+
  geom_point()+
  geom_line(aes(group=fishID))+
  theme_classic()+
  theme(legend.position="none")

#Dropping the first video due to these TOD effects
IndBehav1<-IndBehav1 %>%
  filter(TOD != "1" | TrialTime != "Before")


```
\subsection{Quickly check for stress response when individauls are }


\subsection{Calculate metrics needed for further analyses}

\subsubsection{Calculating all body condition metrics}

```{r calculating the body metrics, warning=FALSE}


#####This code is just to examine how many fish cleared their infection (13)####
# IndBehavRec<- IndBehav1 %>%
#   filter(Recov==1)%>%
#   filter(Fish==1)


#####This code is just to examine how many fish died during their infection (2)#####
 # IndBehavDead<- IndBehav1 %>%
 #   filter(Died==1)%>%
 #   filter(Fish==1)

FemaleOnly<-IndBehav1 %>%
  filter(Sex == 'F')
  
MaleOnly<-IndBehav1 %>%
  filter(Sex == 'M')



#Calculating SMI metrics
#####Preinfection SMI#####

#PreinfectionSMI for females
#To calculate the SMI we take the OLS slope 
lmodel2(log(as.numeric(PreWeight)+1)~log(as.numeric(PreLength)+1), data=FemaleOnly)
#Take the median length from summary
summary(FemaleOnly$PreLength)
#Adding PreSMI to Dataframe
FemaleOnly <- FemaleOnly %>%
  group_by(fishID)%>%
  mutate(PreSMI = PreWeight*((20.20/PreLength)^0.4621474))

#PreinfectionSMI for males
lmodel2(log(as.numeric(PreWeight)+1)~log(as.numeric(PreLength)+1), data=MaleOnly)
#Take the median length from summary
summary(MaleOnly$PreLength)
#Adding PreSMI to Dataframe
MaleOnly <- MaleOnly %>%
  group_by(fishID)%>%
  mutate(PreSMI = PreWeight*((15.30/PreLength)^0.2489888))


#####Late Infection SMI####

#Late infection SMI for females
#Take SMA slope from this model
lmodel2(log(as.numeric(LateWeight)+1)~log(as.numeric(PreLength)+1), data=FemaleOnly)
#Take the median length from summary
summary(FemaleOnly$PreLength)
#Adding PreSMI to Dataframe
FemaleOnly <- FemaleOnly %>%
  group_by(fishID)%>%
  mutate(LateSMI = PreWeight*((20.10/PreLength)^0.3687192))

#Late Infection SMI for males
#Take OLS slope from this model
lmodel2(log(as.numeric(LateWeight)+1)~log(as.numeric(PreLength)+1), data=MaleOnly)
#Take the median length from summary
summary(MaleOnly$PreLength)
#Adding PreSMI to Dataframe
MaleOnly <- MaleOnly %>%
  group_by(fishID)%>%
  mutate(LateSMI = PreWeight*((15.30/PreLength)^0.45174853))
#####

#Bringing the male and female dataframes together to create our overall dataframe
IndBehav2<- rbind(FemaleOnly, MaleOnly)


#View(IndBehav2)


```

\subsubsection{Checking that fish activity is not different at different times of day.}

We recorded the activity of the fish at 3 time periods over the course of the day. Once in the monring between 0900-1100, once in the afternoon 1200-1400, 1500-1700. Therefore we wanted to confirm that there is no consistent Time of day effect before we collapse the behavioral measurements into means for each day. 

```{r checking for TOD effect, warning=FALSE}

#####First visually look at the TOD effect for behavior####
ggplot(IndBehav2, aes(TOD,Velocity))+geom_boxplot()+geom_jitter()+xlab("Time of Day")+ylab("Activity (cm/s)")+theme_classic()

####Verify that this is not statistically significant#####
anova(lm(Velocity~TOD, IndBehav2))

#####Lets also confirm this does not change by sex####
ggplot(IndBehav2, aes(TOD,Velocity, fill=Sex))+geom_boxplot()+geom_jitter()+xlab("Time of Day")+ylab("Activity (cm/s)")+theme_classic()

#####Lets also confirm this does n0t change by Infection Status####
ggplot(IndBehav2, aes(TOD,Velocity, fill=Infection))+geom_boxplot()+geom_jitter()+xlab("Time of Day")+ylab("Activity (cm/s)")+theme_classic()

```
Visually there does not seem to be a distinguished pattern overall and an anova confirms it. It also does not seem to visually differ by sex or infection status. Therefore we can collapse the three different time points within a day to a mean activity and variance of activity across each time point, Before, Early, Late, and Later.


\subsubsection{Calculating the behavioral tolerance metrics needed for analyses}

We are calculating behavioral tolerance through two metrics. First is a measure of behavioral tolerance using linear mixed models using slope random effects for fishID. This allows us to extract each individuals change in activity with parasite burden and therefore allow us to calculate the tolerance (fishID slope) for each individual. This also allows us to use the random effect intercept for fishID as a measure of behavioral vigor. The second way we could calculate these metrics are a measure of change in behavior between two points of behavior (often referred to as point tolerance, CITATION FOR THIS).  This is calculated in the second half of the code as the change in behavior between pre-infection and early, late, and later points of infection. 

```{r calculating the tolerance metrics, warning=FALSE}

#Calulating the behavioral tolerance metrics were interested in for our analysis

#Random slope from random effects model
#####Random effects model with random slope for each fish by worm burden prior to measuring its activity. This slope is the tolerance an individual has to changing its behavior as infection increases. The slope of the behavior is the individuals behavioral vigor, or its pre-infection behavior#####
BehavTolLM<-lmer(Velocity~(Wormbf|fishID), IndBehav2)
summary(BehavTolLM)
#####Extracting the intercept and slope from the linear mixed model####
betaTol <- data.frame(coef(BehavTolLM)$fishID)
#####Renaming the slope and intercept to align with our metrics#####
betaTol <- betaTol %>%
  rename(BehavTol = Wormbf, BehavVig = X.Intercept.)
#####Creating a fishID column for combination with future dataframe####
betaTol<-cbind(fishID=rownames(betaTol), betaTol)

#Calculating the mean and variance in activity per day, per fish

#We need to split the dataframes into the differnet time periods to calculate averages since mutate isnt splitting by TrialTime. 

#####creating a dataframe to calculate the mean and variance of activity for before measurements.#### 

InBehavBefore<- IndBehav2%>%
  drop_na(Velocity)%>%
  filter(TrialTime == "Before")%>%
  select(-c(InfDiff, Fish, Behavdate, Duration, Distance, comp3, Totworm, rate05, rate012,rate512,rate1216,rate18end,TOD,day, linf,maxlinf, maxworm,peakday,Ddate,Rdate, CountDay))%>%
  mutate(AvgVel = mean(Velocity), VarVel = var(Velocity))%>%
  distinct(fishID, .keep_all=TRUE)

#####creating a dataframe to calculate the mean and variance of activity for early measurements.##### 

InBehavEarly<- IndBehav2%>%
  drop_na(Velocity)%>%
  filter(TrialTime == "Early")%>%
  select(-c(InfDiff, Fish, Behavdate, Duration, Distance, comp3, Totworm, rate05, rate012,rate512,rate1216,rate18end,TOD,day, linf,maxlinf, maxworm,peakday,Ddate,Rdate, CountDay))%>%
  mutate(AvgVel = mean(Velocity), VarVel = var(Velocity))%>%
  distinct(fishID, .keep_all=TRUE)


#####creating a dataframe to calculate the mean and variance of activity for Late measurements. #####

InBehavLate<- IndBehav2%>%
  drop_na(Velocity)%>%
  filter(TrialTime == "Late")%>%
  select(-c(InfDiff, Fish, Behavdate, Duration, Distance, comp3, Totworm, rate05, rate012,rate512,rate1216,rate18end,TOD,day, linf,maxlinf, maxworm,peakday,Ddate,Rdate, CountDay))%>%
  mutate(AvgVel = mean(Velocity), VarVel = var(Velocity))%>%
  distinct(fishID, .keep_all=TRUE)

#####creating a dataframe to calculate the mean and variance of activity for Later measurements.####

InBehavLater<- IndBehav2%>%
  drop_na(Velocity)%>%
  filter(TrialTime == "Later")%>%
  select(-c(InfDiff, Fish, Behavdate, Duration, Distance, comp3, Totworm, rate05, rate012,rate512,rate1216,rate18end,TOD,day, linf,maxlinf, maxworm,peakday,Ddate,Rdate, CountDay))%>%
  mutate(AvgVel = mean(Velocity), VarVel = var(Velocity))%>%
  distinct(fishID, .keep_all=TRUE)

####Adding these dataframes together to create one large one####

IndBehav3<-rbind(InBehavBefore, InBehavEarly, InBehavLate, InBehavLater)


#####Pivoting wider so I can subtract activity changes between periods to get change in behavior####
IndBehav4 <- IndBehav3 %>%
  group_by(TrialTime, fishID, add=TRUE)%>%
  select(-Velocity)%>%
  pivot_wider(names_from = TrialTime, values_from = c( Wormbf, Ratebf, AvgVel,VarVel))

#####subset down to infected individuals only and calculate point tolerance metrics for each timeframe. #####
IndBehav4Inf <- IndBehav4 %>%
  filter(Infection == 1) %>%
  mutate(EChBe = AvgVel_Early - AvgVel_Before,
         LChBe = AvgVel_Late - AvgVel_Before,
         LtrChBe = AvgVel_Later - AvgVel_Before,
         ERatebf = (Wormbf_Early - Wormbf_Before)/6,
         LRatebf = (Wormbf_Late - Wormbf_Early)/6,
         LtrRatebf = (Wormbf_Later - Wormbf_Late)/6
         )%>%
  pivot_longer(cols=starts_with("Wormbf"),
               names_to = "TrialTime",
               names_prefix = "Wormbf_",
               values_to = "Wormbf")%>%
  select(-c(AvgVel_Before, AvgVel_Early, AvgVel_Late, AvgVel_Later, Ratebf_Before,Ratebf_Early,Ratebf_Late,Ratebf_Later))%>%
  filter(fishID != c(44,118,139,94))
#####Make two dataframes with pivot longer for wormbf and activity then merge them together on fishID and TrialTime####
IndBehav4InfV<-IndBehav4 %>%
   filter(Infection == 1) %>%
  pivot_longer(cols = starts_with("AvgVel"),
    names_to = "TrialTime",
    names_prefix = "AvgVel_",
    values_to = "AvgVel"
  )%>%
  select(fishID, AvgVel, TrialTime)%>%
  filter(fishID != c(44,118,139,94))

#####Making the growth rate columns into one column for infected individuals####
IndBehavGRInf <- IndBehav4 %>%
  filter(Infection == 1) %>%
  pivot_longer(cols = starts_with("Ratebf"),
      names_to = "TrialTime",
     names_prefix = "Ratebf_",
     values_to = "Ratebf"
   )%>%
  select(fishID,TrialTime, Ratebf)

#####Making the new growth rate columns into one column for infected individuals#####
IndBehavNGRInf <- IndBehav4Inf %>%
  select(fishID, ERatebf, LRatebf, LtrRatebf)%>%
  rename(NRatebf_Early = ERatebf, NRatebf_Late = LRatebf, NRatebf_Later = LtrRatebf)%>%
  add_column(NRatebf_Before = 0)%>%
  pivot_longer(cols = starts_with("NRatebf"),
      names_to = "TrialTime",
     names_prefix = "NRatebf_",
     values_to = "NRatebf"
   )%>%
  select(fishID,TrialTime, NRatebf)%>%
  distinct(fishID,TrialTime, .keep_all=TRUE)

#####Making the Variance columns into one column for infected individuals#####
IndBehavVarInf <- IndBehav4Inf %>%
  select(-TrialTime)%>%
  pivot_longer(cols = starts_with("VarVel"),
      names_to = "TrialTime",
     names_prefix = "VarVel_",
     values_to = "VarVel"
   )%>%
  select(fishID,TrialTime, VarVel)%>%
  distinct(fishID,TrialTime, .keep_all=TRUE)


#####Merging the tolerance and vigor metrics ####
IndBehav4Inf1<-merge(IndBehav4Inf, betaTol, by.x="fishID", by.y = "fishID", .keep=all)

#####Merge the two dataframes together based on the fishID and TrialTime to get all variables we want into one dataframe#####
IndBehav5Inf<-merge(IndBehav4InfV, IndBehav4Inf1, by.x=c("fishID", "TrialTime"), by.y=c("fishID", "TrialTime"), all=TRUE)
IndBehav5Inf2<-merge(IndBehav5Inf, IndBehavGRInf, by.x=c("fishID", "TrialTime"), by.y=c("fishID", "TrialTime"), all=TRUE)
IndBehav5Inf3<-merge(IndBehav5Inf2, IndBehavNGRInf, by.x=c("fishID", "TrialTime"), by.y=c("fishID", "TrialTime"), all=TRUE)
IndBehav5Inf4<-merge(IndBehav5Inf3, IndBehavVarInf, by.x=c("fishID", "TrialTime"), by.y=c("fishID", "TrialTime"), all=TRUE)
#Subset down to uninfected individuals and calculate their point tolerance metrics
#####Creating a dataframe for calculating the tolerance metrics and then pivot longer by Wormbf####
IndBehav4Unf <- IndBehav4 %>%
  filter(Infection == 0)%>%
  mutate(EChBe = AvgVel_Early - AvgVel_Before,
         LChBe = AvgVel_Late - AvgVel_Before,
         LtrChBe = AvgVel_Later - AvgVel_Before,
         NRatebf_Early = (Wormbf_Early - Wormbf_Before)/5,
         NRatebf_Late = (Wormbf_Late - Wormbf_Early)/5,
         NRatebf_Later = (Wormbf_Later - Wormbf_Late)/5,
         )%>%
  pivot_longer(cols = starts_with(c("Wormbf")),
      names_to = "TrialTime",
     names_prefix = c("Wormbf_"),
     values_to="Wormbf"
   )%>%
  select(-c(AvgVel_Before, AvgVel_Early, AvgVel_Late, AvgVel_Later, Ratebf_Before,Ratebf_Early,Ratebf_Late,Ratebf_Later))


#####Creating a second dataframe where we pivot longer for velocity####
IndBehav4UnfV <- IndBehav4 %>%
  filter(Infection == 0)%>%
  pivot_longer(cols = starts_with("AvgVel"),
  names_to = "TrialTime",
  names_prefix = "AvgVel_",
  values_to = "AvgVel"
  )%>%
  select(fishID, TrialTime, AvgVel)


#####Making the growth rate columns into one column for uninfected individuals#####
IndBehavGRUnf <- IndBehav4 %>%
  filter(Infection == 0) %>%
  pivot_longer(cols = starts_with("Ratebf"),
      names_to = "TrialTime",
     names_prefix = "Ratebf_",
     values_to = "Ratebf"
   )%>%
  select(fishID,TrialTime, Ratebf)

#####Making the new growth rate columns into one column for infected individuals#####
IndBehavNGRUnf <- IndBehav4Unf %>%
  select(-TrialTime)%>%
  add_column(NRatebf_Before = 0)%>%
  pivot_longer(cols = starts_with("NRatebf"),
      names_to = "TrialTime",
     names_prefix = "NRatebf_",
     values_to = "NRatebf"
   )%>%
  select(fishID,TrialTime, NRatebf)%>%
  distinct(fishID,TrialTime, .keep_all=TRUE)

#####Making the Variance columns into one column for infected individuals#####
IndBehavVarUnf <- IndBehav4Unf %>%
  select(-TrialTime)%>%
  pivot_longer(cols = starts_with("VarVel"),
      names_to = "TrialTime",
     names_prefix = "VarVel_",
     values_to = "VarVel"
   )%>%
  select(fishID,TrialTime, VarVel)%>%
  distinct(fishID,TrialTime, .keep_all=TRUE)

#####Merge the different datasets together#####
IndBehav5Unf<-merge(IndBehav4UnfV, IndBehav4Unf, by.x=c("fishID", "TrialTime"), by.y=c("fishID", "TrialTime"), all=TRUE)
IndBehav5Unf2<-merge(IndBehav5Unf, IndBehavGRUnf, by.x=c("fishID", "TrialTime"), by.y=c("fishID", "TrialTime"), all=TRUE)
IndBehav5Unf3<-merge(IndBehav5Unf2, IndBehavNGRUnf, by.x=c("fishID", "TrialTime"), by.y=c("fishID", "TrialTime"), all=TRUE)
IndBehav5Unf4<-merge(IndBehav5Unf3, IndBehavVarUnf, by.x=c("fishID", "TrialTime"), by.y=c("fishID", "TrialTime"), all=TRUE)

#Creating the BehavTol and BehavVig columns for the uninfected and calculating the metric for uninfected individual so we can combine these dataframes together
IndBehav5Unf4 <- IndBehav5Unf4 %>%
  group_by(fishID)%>%
  add_column(BehavTol=0, BehavVig= 0)


#Rbinding our infected and uninfected dataframes together into one overall dataframe
IndBehav5<-rbind(IndBehav5Unf4,IndBehav5Inf4)

##Pivot longer for Change in behavior 
IndBehav5ChBe <- IndBehav5%>%
  select(-TrialTime)%>%
  rename(ChBehav_Early=EChBe, ChBehav_Late = LChBe, ChBehav_Later = LtrChBe)%>%
  add_column(ChBehav_Before = 0)%>%
  pivot_longer(cols = starts_with("ChBehav"),
      names_to = "TrialTime",
     names_prefix = "ChBehav_",
     values_to = "ChBehav"
    )%>%
  select(fishID, TrialTime, ChBehav)%>%
  distinct(fishID,TrialTime, .keep_all=TRUE)

#Merge dataframes together for one large dataframe
IndBehav6<-merge(IndBehav5, IndBehav5ChBe, by.x=c("fishID", "TrialTime"), by.y=c("fishID", "TrialTime"), all=TRUE)

#Removing some of the columns we dont want in the dataframe
#Create a point tolerance metric for each timepoint
IndBehav6 <- IndBehav6%>%
  select(-c(ERatebf,LRatebf,LtrRatebf, NRatebf_Early,NRatebf_Late,NRatebf_Later, VarVel_Before,VarVel_Early, VarVel_Late, VarVel_Later))%>%
  mutate(PTol = ChBehav/Wormbf)%>%
  mutate(PTol=replace(PTol, PTol == NaN, 0))%>%
  mutate(PTol=replace(PTol, PTol == -Inf, 0))%>%
  mutate(PTol=replace(PTol, PTol == Inf, 0))%>%
  select(-c(EChBe,LChBe,LtrChBe))%>%
  distinct(fishID,TrialTime, .keep_all=TRUE)%>%
  drop_na(Sex)

#Remove dataframes used for data wrangling and managing
# rm(c(IndBehav, IndBehav1,IndBehav2,IndBehav3,IndBehav3Inf1,IndBehav4,IndBehav4Inf,IndBehav4Inf1,IndBehav4InfV,IndBehav4Unf,IndBehav4UnfV,IndBehav5,IndBehav52,IndBehav5ChBe,IndBehav5Inf,IndBehav5Inf2,IndBehav5Inf3,IndBehav5Inf4,IndBehavVarUnf,IndBehavVarInf,IndBehavNGRUnf,IndBehavNGRInf,IndBehavGRUnf,IndBehav5Unf4,IndBehav5Unf3,IndBehav5Unf2,IndBehav5Unf))

#Setting some characters as factors
IndBehav6$TrialTime<-as.factor(IndBehav6$TrialTime)
IndBehav6$Sex<-as.factor(IndBehav6$Sex)
IndBehav6$Infection<-as.factor(IndBehav6$Infection)
IndBehav6$ContInf<-as.factor(IndBehav6$ContInf)
IndBehav6$Died<-as.factor(IndBehav6$Died)
IndBehav6$Treatment<-as.factor(IndBehav6$Treatment)

ggplot(IndBehav6, aes(x=PreLength,y=PreWeight))+geom_point()+geom_smooth(method="lm")+facet_wrap(~Sex)

ggplot(IndBehav6, aes(x=PreLength,y=LateWeight))+geom_point()+geom_smooth(method="lm")+facet_wrap(~Sex)


# #Exporting dataframe for saving
write.csv(IndBehav6, "IndividualBehaviors_20240603.csv")


```

Now we have to decided how best to calculate whether an individual has recovered. In the experiment only had 13 fish recover from infection totally, therefore we are thinking of another metric that indicates a fish is in recovery during infection. 

\subsection{Description of data, structure, and type}

\textbf{fishID}: The individual ID of each fish used in the trial. \newline
\textbf{TrialTime}: The point of infection where each behavior trial happened. Early - early infection (6 days), Late - late in infection (12 days), Later - later in infection (18 days)\newline
\textbf{AvgVel}: The average activity from three separate behavioral trials of each fish for each of the Trial Times. ($cm/s$) \newline
\textbf{Sex}: The sex of the individual. F - female, M - male \newline
\textbf{PreWeight}: The weight of the individual prior to their fist behavior trial and pre-infection. ($grams$)  \newline
\textbf{PreLength}: The length of the individual prior to their first behavior trial and pre-infection ($mm$) \newline
\textbf{Treatment}: What treatment the fish received prior to their first behavior and pre-infection. VIE - visible implant elastomer implant, UNTOUCHED - control individual, received no injection nor implant ($mm$) \newline
\textbf{Infection}: Whether or not the individual was infected with Gyrodactylus turnbulli. 1 - infected, 0 - uninfected \newline
\textbf{LateWeight}: The weight of the individual after their final behavior trial and after infection. ($grams$) \newline
\textbf{wormJump}: The number of worms that jumped from the donor fish to the trial fish during manual infections. \newline
\textbf{AUC2}: The area under the curve of infection over the total infection trajectory for each individual. \newline
\textbf{RecovPeriod}: The time frame in which an individual started recovering from infection. This is calculated by looking at the growth rate of the worms between each count and see when the worm growth rate was decreasing overall. \newline
\textbf{ContInf}: Whether or not the individual was controling infection. We qualified controling infection by having a negative growth rate post peak infection. 1 - Controlled, 0 - Uncontrolled \newline
\textbf{Died}: Whether or not the individual Died from infection during the experimental trial. 1 - Died, 0 - did not died \newline
\textbf{PreSMI}: The body condition of the individual prior to their first behavioral trial and pre infection. ($mm/g$) \newline
\textbf{LateSMI}: The body condition of the individual after to their last behavioral trial and after infection. ($mm/g$) \newline
\textbf{Wormbf}:The number of worms on the fish prior to each trial. \newline
\textbf{Ratebf}:The rate of growth of worms on the fish prior to each trial from the worm count immediately prior to the trial. \newline
\textbf{NRatebf}:The rate of growth of worms on the fish prior to each trial calculated as the change in worms between each time point. (For Example, From before to early). \newline
\textbf{VarVel}:The variance in activity from the separate behavioral trials during each time point. ($(cm/s)^2$) \newline
\textbf{BehavTol}:The behavioral tolerance of each individual calculated as the slope of a random effect model where fishID is the random effect term. ($cm/s/worms$)  \newline
\textbf{BehavVig}:The behavioral Vigor of each individual calculated as the activity of each individual's pre-infection measurements \newline
\textbf{ChBehav}:The change in activity behavior between trial times. ($cm/s$) \newline
\textbf{PTol}:Point tolerance metric calculated by dividing the change in behavior between time points by the worms on the fish before the trial ($cm/s/worms$) \newline



\subsection{Visualizing the relationships between variables in our dataset}
```{r primary visualization for our variables for analysis, warning=FALSE}
pairs(~AvgVel+TrialTime+Sex+Treatment+Infection+LateWeight+AUC2+Died+PreSMI+LateSMI+Wormbf+Ratebf+NRatebf+VarVel+BehavTol+BehavVig+ChBehav, lower.panel=panel.smooth, diag.panel=panel.hist, 
upper.panel=panel.cor, data=IndBehav6)


```

\subsection{Visualize some patterns in the raw data}

```{r Loading in completed data set and some quick manipulations before we get into analysis, warning = FALSE}

#Load in dataset from above. This bit of code is meant to save time so people dont have to rerun the entire data parsing and calculating step above. Code will be saved for reproducibility.
IndBehav7 <- read_csv("IndividualBehaviors_20240501.csv")

#Setting some of the factors back to factors
IndBehav7$fishID<-as.factor(IndBehav7$fishID)
IndBehav7$TrialTime<-as.factor(IndBehav7$TrialTime)
IndBehav7$Sex<-as.factor(IndBehav7$Sex)
IndBehav7$Infection<-as.factor(IndBehav7$Infection)
IndBehav7$ContInf<-as.factor(IndBehav7$ContInf)
IndBehav7$Died<-as.factor(IndBehav7$Died)
IndBehav7$Treatment<-as.factor(IndBehav7$Treatment)


#Calculating tissue tolerance for each individual. 
IndBehav7<-IndBehav7%>%
  mutate(ChSMI = LateSMI - PreSMI)%>%
  mutate(TisTol = ChSMI/Totworm)

 #Subsetting down to female and males only to scale their SMI
 #Males
 IndBehavM<-IndBehav7%>%
   filter(Sex=="M")%>%
   mutate(ScPSMI = scale(PreSMI), ScLSMI = scale(LateSMI ))


 #Females
 IndBehavF<-IndBehav7%>%
   filter(Sex=="F")%>%
   mutate(ScPSMI= scale(PreSMI), ScLSMI = scale(LateSMI))

#Combine the two separate dataframes together
 IndBehav8<-rbind(IndBehavF, IndBehavM)

#Scaling some variables to make them biologically comparable and better for model fitting

IndBehav8 <- IndBehav8 %>%
  mutate(
         ScVarvelBef = c(scale(VarvelBef)),
         ScNRatebf = c(scale(NRatebf)),
         ScBehavTol = c(scale(BehavTol)),
         ScTotworm = c(scale(Totworm)),
         ScAUC = c(scale(AUC2)),
         ScBehavVig = c(scale(BehavVig)),
         ScChSMI = c(scale(ChSMI)),
         ScTisTol = c(scale(TisTol)))


IndBehav8$fishID<-as.character(IndBehav8$fishID)




```


\section{Calculating athe total area of a polygon based on the number of worms and the avergae activity of each individual}

This metric is used as a combination as the tolerance (change in behavior) and resistance (the change in parasites over the course of infection).

```{r New Metric of tolerance, warning=FALSE, echo=FALSE, include=FALSE}
#Visually inspecting the ploygons for the change in behavior as parasite load increases
ggplot(IndBehav7, aes(x=Wormbf, y=AvgVel, color=fishID))+
  geom_point()+
  theme_classic()+
  theme(legend.position="none")+
  geom_polygon(aes(fill=fishID, alpha=1/10))

#Creating a dataframe that is missing the NAs for average velocity and Wormbf from fish who died/recovered during infection. 
NonNABehav<-IndBehav8 %>%
  drop_na(c(AvgVel, Wormbf))

#Setting Levels as a character
Levels<-as.character(NonNABehav$fishID)

#Subsetting down to only unique variables in fishID/Levels
Levels <- Levels%>%
  unique()
  


#Calculating the area of those polygons 
#Creating empty dataframes and columsn
TotalAreas<-as.data.frame(Levels)
TotalAreas$PolyArea<- NA


#For Loop for calculating the area of the polygon of change in fish behavior with parasite ID
for(i in 1:length(TotalAreas$Levels)){
  current_fish <- TotalAreas$Levels[i]
  
Convex_hull <- NonNABehav%>%
  filter(fishID == current_fish)%>%
  select(AvgVel, Wormbf)%>%
  slice(chull(Wormbf, AvgVel))

 TotalAreas$PolyArea[i] <- as.matrix(Convex_hull)%>%areapl
 
 print(current_fish)

}

#Renaming the Levels as fishID for merging
TotalAreas$fishID <- TotalAreas$Levels

#Removing the levels column
TotalAreas <- TotalAreas%>%
  select(-Levels)

#Merging the TotalAreas with our data frame
IndBehav8<-merge(IndBehav8, TotalAreas, by.x=c("fishID"), by.y=c("fishID"), all=TRUE)

#subsetting out before measurements 

IndBehav8 <- IndBehav8 %>%
  filter(TrialTime != "Before")%>%
  mutate(ResidPLength = resid(lm(PreLength~Sex)))%>%
  mutate(ResidPLSMI = resid(lm(ScPSMI~ResidPLength)))%>%
  mutate(ScResidPLSMI = c(scale(ResidPLSMI)))%>%
  mutate(ScRPLength = c(scale(ResidPLength)))

#Filtering the data set for individuals who are not controlling for infection.
IndBehavCont<-IndBehav8%>%
  filter(ContInf == "0" | ContInf == "1")

#Filtering to only infected individuals for tolerance metrics
IndBehavI<-IndBehav8%>%
  filter(Infection == "1")%>%
  distinct(fishID, .keep_all=TRUE)


```


```{r Visualizing patterns using the raw data, warning=FALSE, include= FALSE}
#What does the average behavior look like for individuals who are recovering from infection
#Note NA here is uninfected individuals since they could not recover from infection
ggplot(IndBehav8, aes(TrialTime, AvgVel, group = fishID))+
  geom_smooth(se=FALSE)+
  facet_wrap(~ContInf)+
  theme_classic()+
  theme(legend.position = "none")



#What does worm burden look like for individuals who are recovering from infection and those that have not
ggplot(IndBehavCont, aes(TrialTime, Wormbf, group = fishID))+
  geom_smooth(aes(color=fishID), se=FALSE)+
  facet_wrap(~ContInf)+
  theme_classic()+
  theme(legend.position = "none")


#What does variance in behavior look like for individuals who are recovering from infection
#Note NA here is uninfected individuals since they could not recover from infection
ggplot(IndBehav8, aes(TrialTime, VarVel, group = fishID))+
  geom_smooth(se=FALSE)+
  facet_wrap(~ContInf)+
  theme_classic()+
  theme(legend.position = "none")


#Is there sexual variation in the behavioral tolerance of individuals?
#Note this is the behavioral tolerance calculated as the individaul slope from activity and parasite burden for each individual 
ggplot(IndBehav8, aes(Sex, BehavTol))+
  geom_boxplot()+
  geom_jitter()+
  theme_classic()+
  theme(legend.position = "none")

#How does this look relative to the point tolerance metrics we calculated?

ggplot(IndBehav8, aes(Sex, PTol))+
  geom_boxplot(aes(outlier=FALSE))+
  geom_jitter()+
  theme_classic()+
  theme(legend.position = "none")



#Is there sexual variation in the behavioral vigor of individuals?
ggplot(IndBehav8, aes(Sex, BehavVig))+
  geom_boxplot()+
  geom_jitter()+
  theme_classic()+
  theme(legend.position = "none")


#How does Behavioral Vigor correlate with Behavioral Tolerance
#This first graph is using the tolerance metric from the individual random slope
ggplot(IndBehavI, aes(BehavTol, BehavVig))+
  geom_smooth(method="lm")+
  geom_jitter()+
  theme_classic()+
  theme(legend.position = "none")+
  facet_wrap(~Sex)


#This next graph is using the tolerance metric calculated as the point tolerance change between timepoints
# 
# ggplot(IndBehavI, aes(PTol, BehavVig))+
#   geom_smooth(method="lm")+
#   geom_jitter()+
#   theme_classic()+
#   facet_wrap(~TrialTime)+
#   theme(legend.position = "none")



#How does Behavioral Vigor correlate with Behavioral Tolerance
#This first graph is using the tolerance metric from the individual random slope
ggplot(IndBehavI, aes(y=BehavTol, x=BehavVig))+
  geom_smooth(method="lm")+
  geom_jitter()+
  theme_classic()+
  facet_wrap(~Sex)+
  theme(legend.position = "none")

###Now lets see how these relationships look based on sex
#This next graph is using the tolerance metric calculated as the point tolerance change between timepoints

ggplot(IndBehavI, aes(PTol, BehavVig))+
  geom_smooth(method="lm")+
  geom_jitter()+
  theme_classic()+
  facet_wrap(~Sex)+
  theme(legend.position = "none")


#How does Behavioral Vigor relate to total infeciton

ggplot(IndBehavI, aes(BehavVig, AUC2))+
  geom_smooth(method="lm")+
  geom_jitter()+
  theme_classic()+
  facet_wrap(~Sex)+
  theme(legend.position = "none")


#How does individual condition relate to behavioral tolerance
ggplot(IndBehavI, aes(BehavTol, ScPSMI))+
  geom_smooth(method="lm")+
  geom_jitter()+
  theme_classic()+
  facet_wrap(~Sex)+
  theme(legend.position = "none")

#How does individual condition relate to behavioral tolerance
ggplot(IndBehavI, aes(BehavVig, ScPSMI))+
  geom_smooth(method="lm")+
  geom_jitter()+
  theme_classic()+
  facet_wrap(~Sex)+
  theme(legend.position = "none")

#How does Tissue tolerance relate to behavioral tolerance
IndBehavI1<- IndBehavI %>%
  filter(ScTisTol <1 & ScTisTol >-4)


ggplot(IndBehavI1, aes(ScBehavTol, ScTisTol))+
  geom_smooth(method="lm")+
  geom_jitter()+
  theme_classic()+
  facet_wrap(~Sex)+
  theme(legend.position = "none")


#How does Tissue tolerance relate to behavioral tolerance

ggplot(IndBehavI, aes(PreSMI, TisTol))+
  geom_smooth(method="lm")+
  geom_jitter()+
  theme_classic()+
  facet_wrap(~Sex)+
  theme(legend.position = "none")


#How does TisTol differ by sex?
ggplot(IndBehav8, aes(Sex, TisTol))+
  geom_boxplot()+
  geom_jitter()+
  theme_classic()+
  theme(legend.position = "none")

ggplot(IndBehavI, aes(y=PolyArea, x=BehavVig))+
  geom_smooth(method="lm")+
  geom_jitter()+
  theme_classic()+
  facet_wrap(~Sex)+
  theme(legend.position = "none")

```


\subsection{What hypotheses we want to test with these data and what data we can use to test them?}

For uninfected and infected individuals only:

  Do infected and uninfected individuals differ in their average and variation in     activity?
 
  Is there sexual variation in the average and variation in activity?

  Do we see differences in the change in behavior and between infected and uninfected indivdiauls?


For infected individuals only: 

Does activity predict the intensity of infection?


  Is there sexual variation in host behavioral tolerance and behavioral vigor? 

  Do host behavioral tolerance, tissue tolerance, and behavioral vigor correlate together and does this differ by sex? 

  Do hosts with lower behavioral tolerance have higher behavior resilience (i.e. how hosts behave once they have started to clear infection/have cleared infection)

  Is there sexual variation in individuals behavioral resilience? 
  
  polygon area as resilience and how this relates to other metrics


```{r more specific visualization of explanatory variables mentioned above, warning = FALSE, include=FALSE}

pairs(~AvgVel+Sex+Infection+AUC2+NRatebf+VarVel+BehavTol+ScPSMI+BehavVig+TisTol+ResidPLength+Treatment, lower.panel=panel.smooth, diag.panel=panel.hist, 
upper.panel=panel.cor, data=IndBehav8)

```

\section{Do infected and uninfected individuals differ in their average and variation in activity?}

\subsection{Visually inspection of the explanatory variables that will be used in the analyses}

```{r visual inspection of variables that will be used in the analysis, warning= FALSE}

pairs(~AvgVel+VarVel+Sex+Infection+TrialTime+Treatment+ResidPLSMI+ResidPLength+TisTol, lower.panel=panel.smooth, diag.panel=panel.hist, 
upper.panel=panel.cor, data=IndBehav8)

boxplot(ResidPLSMI~Sex, IndBehav8)

plot(PreWeight~PreLength, IndBehav8)


```

\subsection{Does infection or sex variation impact the average activity of individauls?}

Individuals had 3 behavioral trials per time period of infection (i.e. 3 behavioral trials before infection) and therefore using preliminary analysis we showed that there is no difference due to time of day of these recordings so we averaged and quantified the variance of the velocities for that day to get an average activity per trial time.  

This analysis uses the average activity for each individual at each trial point. 

\subsubsection{Description, development, and fitting of linear model for the analysis}

We will use a linear mixed model to analyze how average activity differs by infection status and sexual variation. FishID is included as a random term to allow for non-independence of individuals due to multiple measurements per individual across time.

* Deterministic
 + $AvgVel_{det}$ = a + $b_{1}$TrialTime + $b_{2}$Infection * $b_{3}$Sex + $b_{4}$ScPSMI + $b_{5}$ScRPLength + $b_{6}$Treatment + $a_{i}$

* Stochastic
  + AvgVel ~ *N*($AvgVel_{det}$, $\sigma^{2}$) 
  + $a_{i}$ ~ *N*(0, $\sigma^{2}_{fishID}$) 
  
* Fixed
  + TrialTime
  + Infection status
  + Sex 
  + An interaction between Sex and Infection status
  + Scaled Pre-infection SMI
  + Scaled residuals from length and sex
  + VIE Treatment 
* Random
  + fishID
  
  
  
```{r fitting the linear mixed model, warning=FALSE}

#Fit a linear model for checking what explanatory factors are important for Average activity
#Note this is a linear mixed model because we have multiple measures per fish and therefore, need to account for non-independence between measures. 
AvgVelLM<-lmer(AvgVel~TrialTime+Infection*Sex+ScPSMI+ScRPLength+Treatment+(1|fishID), IndBehav8)



#Summary to see the relationship of the variables. 
summary(AvgVelLM)
```

\subsubsection{Validate that the model fits well and there are no problems}


```{r model validation for the avergae activity model, warning=FALSE}

#Using the check_model function from the perforamnce package to check the model validation

check_model(AvgVelLM, check=c("qq","normality", "homogeneity"))

#Using the Dharma package to check quantile residuals
#First simulating the quantile residuals
sim_residuals_AvgVelLM <-simulateResiduals(AvgVelLM, 1000)
#Plotting the quantile residuals to test how quantile residuals look
plot(sim_residuals_AvgVelLM) 
#Testing for dispersion
testDispersion(sim_residuals_AvgVelLM)

#All model validation looks good. 

```

\subsubsection{Testing the significance of factors in our model using a Kenward-Rodgers F test}


```{r using anova to perform a kenward-Rodgers F test, warning=FALSE}

#F test to test for signficance of slope of variables
Anova(AvgVelLM, test="F", type=3)

```

\subsubsection{Visualize the important explanatory factors for average activity}


```{r visualizing Trialtime by average activity, warning=FALSE}
#TrialTimeGraph
AvgVelbyTT=visreg(AvgVelLM, scale="response", "TrialTime", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Average activity (cm/s)")+
  xlab(" ")+
  theme(text=element_text(size=22))
#Print the graph
print(AvgVelbyTT)



```

```{r visualizing Sex by average activity, warning=FALSE}
#TrialTimeGraph
AvgVelbySex=visreg(AvgVelLM, scale="response", "Sex", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Average activity (cm/s)")+
  xlab(" ")+
  theme(text=element_text(size=22))
#Print the graph
print(AvgVelbySex)


```

```{r visualizing Sex by PreSMI, warning=FALSE, ignore=TRUE, include=FALSE}
#TrialTimeGraph
AvgVelbySMI=visreg(AvgVelLM, scale="response", "ScPSMI", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Average activity (cm/s)")+
  xlab("Scaled Pre-infection SMI (mm/g)")+
  theme(text=element_text(size=22))
#Print the graph
print(AvgVelbySMI)


```

\subsection{Does infection or sex variation impact the variance in activity of individauls?}

This analysis uses the variance of activity for each individual at each trial point. 

\subsubsection{Description, development, and fitting of linear model for the analysis}

We will use a linear mixed model to analyze how variance in activity differs by infection status and sexual variation. FishID is included as a random term to allow for non-independence of individuals due to multiple measurements per individual across time.

* Deterministic
 + $log(VarVel_{det})$ = a + $b_{1}$TrialTime + $b_{2}$Infection + $b_{3}$Sex + $b_{4}$ScPSMI + $b_{5}$ScRPLength + $b_{6}$Treatment + $a_{i}$

* Stochastic
  + log(VarVel) ~ *N*($log(VarVel_{det})$, $\sigma^{2}$) 
  + $a_{i}$ ~ *N*(0, $\sigma^{2}_{fishID}$) 
  
* Fixed
  + TrialTime
  + Infection
  +  Sex 
  + Scaled Pre-infection SMI
  + Scaled residuals from length and sex
  + VIE Treatment 
* Random
  + fishID
  
  

```{r fitting the variance of activity model, warning=FALSE, include=FALSE}

#Fit a linear model for checking what explanatory factors are important for Variance in activity
#Note this is a linear mixed model because we have multiple measures per fish and therefore, need to account for non-independence between measures. 
VarVelLM<-lmer(log(VarVel)~Sex*Infection+ScPSMI+TrialTime+ScRPLength+Treatment+(1|fishID),IndBehav8) 

#Summary to see the relationship of the variables. #Summary to see the relagaussian()tionship of the variables. 
summary(VarVelLM)

```

\subsubsection{Validate that the model fits well and there are no problems}


```{r model validation for the Variance in activity model, warning=FALSE, include=FALSE}

#Using the check_model function from the perforamnce package to check the model validation

check_model(VarVelLM,check=c("qq","normality", "homogeneity"))

#Using the Dharma package to check quantile residuals
#First simulating the quantile residuals
sim_residuals_VarVelLM <-simulateResiduals(VarVelLM, 1000)
#Plotting the quantile residuals to test how quantile residuals look
plot(sim_residuals_VarVelLM) 
#Testing for dispersion
testDispersion(sim_residuals_VarVelLM)

#There are some problems with this model validation. It doesnt look model breaking but definitely should look at other model error structures to resolve the issues. 

```

\subsubsection{Testing the significance of factors in our model using a Kenward-Rodgers F test}


```{r using anova to perform a kenward-Rodgers F test for the variance model, warning=FALSE, include=FALSE}

#F test to test for signficance of slope of variables
Anova(VarVelLM, test="F", type=3)

```

\subsubsection{Visualize the important explanatory factors for variance of activity}

```{r visual for variance in activity, warning=FALSE, include=FALSE}

#VariancebySex
VarVelbySex<-visreg(VarVelLM, scale="response", "Sex", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Variance in activity (cm/s)")+
  xlab(" ")+
  theme(text=element_text(size=22))

#Print the graph
print(VarVelbySex)

```


\section{Do we see differences in change in behavior over time based on infection status and sexual variation?}


\subsection{Visually inspection of the explanatory variables that will be used in the analyses}

```{r visual inspection of variables that will be used in the analysis for change in behavior, warning=FALSE}

pairs(~ChBehav+Sex+Infection+TrialTime+PreSMI+AUC2+Treatment+ResidPLength, lower.panel=panel.smooth, diag.panel=panel.hist, 
upper.panel=panel.cor, data=IndBehav8)

```


\subsubsection{Description, development, and fitting of linear model for the analysis}

We will use a linear mixed model to analyze how Change in activity differs by infection status and sexual variation. FishID is included as a random term to allow for non-independence of individuals due to multiple measurements per individual across time.

* Deterministic
 + $ChVel_{det}$ = a + $b_{1}$TrialTime + $b_{2}$Infection * $b_{3}$Sex + $b_{4}$ScRPLength + $b_{5}$Treatment + $a_{i}$

* Stochastic
  + ChVel ~ *N*($ChVel_{det}$, $\sigma^{2}$) 
  + $a_{i}$ ~ *N*(0, $\sigma^{2}_{fishID}$) 
  
* Fixed
  + TrialTime
  + Infection
  +  Sex 
  + Interaction between Sex and infection status
  + Scaled residuals from length and sex
  + VIE treatment of the fish
  
* Random
  + fishID
  
```{r fitting the change in behavior model, warning=FALSE}

#Fit a linear model for checking what explanatory factors are important for Variance in activity
#Note this is a linear mixed model because we have multiple measures per fish and therefore, need to account for non-independence between measures. 
ChVelLM<-lmer(ChBehav~TrialTime+Infection*Sex+ScChSMI+ScRPLength+Treatment+(1|fishID), IndBehav8)

#Summary to see the relationship of the variables. 
summary(ChVelLM)



```
  
\subsubsection{Validate that the model fits well and there are no problems}


```{r model validation for the Change in activity model, warning=FALSE}

#Using the check_model function from the perforamnce package to check the model validation

check_model(ChVelLM,check=c("qq","normality", "homogeneity"))

#Using the Dharma package to check quantile residuals
#First simulating the quantile residuals
sim_residuals_ChVelLM <-simulateResiduals(ChVelLM, 1000)
#Plotting the quantile residuals to test how quantile residuals look
plot(sim_residuals_ChVelLM) 
#Testing for dispersion
testDispersion(sim_residuals_ChVelLM)

#There are some problems with this model validation. It doesnt look model breaking but definitely should look at other model error structures to resolve the issues. 

```
  
  \subsubsection{Testing the significance of factors in our model using a Kenward-Rodgers F test}


```{r using anova to perform a kenward-Rodgers F test for change in behavior, warning=FALSE}

#F test to test for signficance of slope of variables
Anova(ChVelLM, test="F", type=3)

```



\subsubsection{Visualize the important explanatory factors for change in velocity}


```{r visualizing Trialtime by Change in activity, warning=FALSE}
#TrialTimeGraph
ChVelbyTT=visreg(ChVelLM, scale="response", "TrialTime", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Change in Velocity (cm/s)")+
  xlab(" ")+
  theme(text=element_text(size=22))
#Print the graph
print(ChVelbyTT)

```


\section{Is there sexual variation in host behavioral tolerance and behavioral vigor?}

\subsection{Visually inspection of the explanatory variables that will be used in the analyses}
```{r vsiaully inspecting covariates for the tolerance model, warning=FALSE}

pairs(~ScTisTol+Sex+PreSMI+ScVarvelBef+ScBehavTol+ScBehavVig+ScRPLength+ScResidPLSMI, lower.panel=panel.smooth, diag.panel=panel.hist,
upper.panel=panel.cor, data=IndBehav8)

boxplot(PreSMI~Sex, IndBehav8)

```

\subsection{What factors are important for host behavioral vigor and do is there any sexual variation in host behavioral vigor?}

\subsubsection{Description, development, and fitting of linear model for the analysis}

We will use a linear model to analyze how behavioral vigor differs by sexual variation and other important host traits. Given each host only has one behavioral vigor measure, we do not need the fishID random effect used in previous models/ 

* Deterministic
 + $BehavVig_{det}$ = a + $b_{1}$Sex + $b_{2}$ScResidPLSMI + $b_{3}$ScVarVelBef + $b_{4}$ScRPLength + $b_{5}$Treatment + $b_{6}$Sex:ScResidPLSMI + $b_{7}$Sex:ScRPLength + $a_{i}$

* Stochastic
  + BehavVig ~ *N*($BehavVig_{det}$, $\sigma^{2}$) 
  + $a_{i}$ ~ *N*(0, $\sigma^{2}_{BehavGroup}$) 

  
* Fixed
  + Sex 
  + Scaled residuals from Pre-infection SMI and length
  + Scaled variance in velocity before infection
  + Scaled residuals from length and sex
  + VIE treatment
  + An interaction between sex and Pre-infection SMI
  + An interaction between sex and Pre-infection Length
  
* Random
  + Behavior group of recording


```{r fitting the Behavioral Vigor model, warning=FALSE}

#Fit a linear model for checking what explanatory factors are important for Variance in Velocity
#Note this is a linear mixed model because we have multiple measures per fish and therefore, need to account for non-independence between measures. 
BehavVigLM<-glmmTMB(BehavVig~Sex*ScResidPLSMI+ScVarvelBef+ScRPLength+Treatment+Sex:ScRPLength+(1|BehavGroup), family=Gamma("log"), IndBehav8)

#Summary to see the relationship of the variables. 
summary(BehavVigLM)


```


\subsubsection{Validate that the model fits well and there are no problems}

```{r model validation for the behavior vigor model, warning=FALSE}

#Using the check_model function from the perforamnce package to check the model validation

check_model(BehavVigLM)


#Using the Dharma package to check quantile residuals
#First simulating the quantile residuals
sim_residuals_BehavVigLM <-simulateResiduals(BehavVigLM, 1000)
#Plotting the quantile residuals to test how quantile residuals look
plot(sim_residuals_BehavVigLM) 
#Testing for dispersion
testDispersion(sim_residuals_BehavVigLM)

```

\subsubsection{Testing the significance of factors in our model}

```{r checking significance of fixed effects, warning=FALSE}

Anova(BehavVigLM, type=3, test="Chisq")

```

\subsubsection{Visualize the important explanatory factors for behavioral vigor}

```{r visualing the pattern between behavioral vigor and Variance}
#Variance in behaivor
BehavVigbyVar=visreg(BehavVigLM, scale="response", "ScVarvelBef", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Behavioral Vigor (cm/s)")+
  xlab("Variance in pre-infection behavior (cm/s^2)")+
  theme(text=element_text(size=22))
#Print the graph
print(BehavVigbyVar)
```

```{r visualing the pattern between behavioral vigor and SMI}
#TrialTimeGraph
BehavVigbySMI=visreg(BehavVigLM, scale="response", "ScResidPLSMI", "Sex", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Behavioral Vigor (cm/s)")+
  xlab("Scaled Pre-infeciton mass index (mm/mg)")+
  theme(text=element_text(size=22))+
  facet_wrap(~Sex)
#Print the graph
print(BehavVigbySMI)
```

```{r visualing the pattern between behavioral vigor and Length}
#TrialTimeGraph
BehavVigbyLength=visreg(BehavVigLM, scale="response", "ScRPLength", "Sex", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Behavioral Vigor (cm/s)")+
  xlab("Scaled Pre-infeciton Length (mm)")+
  theme(text=element_text(size=22))+
  facet_wrap(~Sex)
#Print the graph
print(BehavVigbyLength)
```

\subsubsection{Post-hoc analysis where we split by sex}

```{r fitting the Behavioral Vigor model for post hoc analysis by sex, warning=FALSE}

IndBehav8M <- IndBehav8 %>%
  filter( Sex== "M")

IndBehav8F <- IndBehav8 %>%
  filter( Sex== "F")

#Fit a linear model for checking what explanatory factors are important for Variance in Velocity
#Note this is a linear mixed model because we have multiple measures per fish and therefore, need to account for non-independence between measures. 
#Females
BehavVigLMF<-glmmTMB(BehavVig~ScResidPLSMI+ScVarvelBef+Treatment+ScRPLength+(1|BehavGroup), family=Gamma("log"), IndBehav8F)
#Males
BehavVigLMM<-glmmTMB(BehavVig~ScResidPLSMI+ScVarvelBef+ScRPLength*Treatment+(1|BehavGroup), family=Gamma("log"), IndBehav8M)

#Summary to see the relationship of the varialbes for females
summary(BehavVigLMF)



#Summary to see the relationship of the variables for males. 
summary(BehavVigLMM)

```


```{r model validation for the post hoc behavior vigor model, warning=FALSE}


#Using the Dharma package to check quantile residuals for female vigor model
#First simulating the quantile residuals
sim_residuals_BehavVigLMF <-simulateResiduals(BehavVigLMF, 1000)
#Plotting the quantile residuals to test how quantile residuals look
plot(sim_residuals_BehavVigLMF) 
#Testing for dispersion
testDispersion(sim_residuals_BehavVigLMF)


#Using the Dharma package to check quantile residuals for female vigor model
#First simulating the quantile residuals
sim_residuals_BehavVigLMM <-simulateResiduals(BehavVigLMM, 1000)
#Plotting the quantile residuals to test how quantile residuals look
plot(sim_residuals_BehavVigLMM) 
#Testing for dispersion
testDispersion(sim_residuals_BehavVigLMM)

```

\subsubsection{Testing the significance of factors in our model}

```{r checking significance of post hoc fixed effects, warning=FALSE}

Anova(BehavVigLMF, type=2, test="Chisq")

Anova(BehavVigLMM, type=2, test="Chisq")

```


\subsection{What factors are important for host behavioral tolerance and do is there any sexual variation in host behavioral tolerance?}


\subsubsection{Description, development, and fitting of linear model for the analysis}

We will use a linear model to analyze how behavioral tolerance differs by sexual variation and other important host traits. Given each host only has one behavioral tolerance measure, we do not need the fishID random effect used in previous models/ 

* Deterministic
 + $BehavTol_{det}$ = a + $b_{1}$Sex + $b_{2}$ScRPLength + $b_{3}$ScVarVelBef + $b_{4}$ScResidPLSMI + $b_{5}$ScBehavVig + $b_{5}$ScTisTol + $b_{6}$Sex:ScRPLength + $a_{i}$

* Stochastic
  + BehavTol ~ *N*($BehavTol_{det}$, $\sigma^{2}$) 
  + $a_{i}$ ~ *N*(0, $\sigma^{2}_{BehavGroup}$) 
  
* Fixed
  + Sex 
  + Scaled residual from length and sex
  + Scaled Pre-infection SMI
  + Scaled variance in velocity before infection
  + Scaled behavioral vigor
  + Scaled Tissue Tolerance
  + Sex by length residuals interaction
  
  
```{r linear model for behavorial tolerance}
#We have some outliers that make interpreting the results for behavioral tolerance a pain so were removing them from the analysis

#Fit a linear model for behavioral tolerance
#Note this is a linear mixed model because we have multiple measures per fish and therefore, need to account for non-independence between measures. 
BehavTolLM<-glmmTMB(BehavTol~Sex+ScResidPLSMI+ScChSMI+ScVarvelBef+ScRPLength+ScBehavVig+Treatment+(1|BehavGroup), IndBehavI)



#Summary to see the relationship of the variables. 
summary(BehavTolLM)

```
  
\subsubsection{Validate that the model fits well and there are no problems}

```{r model validation for the behavior tolerance model, warning=FALSE}

#Using the check_model function from the perforamnce package to check the model validation

check_model(BehavTolLM)

#Using the Dharma package to check quantile residuals
#First simulating the quantile residuals
sim_residuals_BehavTolLM <-simulateResiduals(BehavTolLM, 1000)
#Plotting the quantile residuals to test how quantile residuals look
plot(sim_residuals_BehavTolLM) 
#Testing for dispersion
testDispersion(sim_residuals_BehavTolLM)

```


\subsubsection{Testing the significance of factors in our model}

```{r checking significance of fixed effects for tolerance model, warning=FALSE}

Anova(BehavTolLM, Type=3, test="Chisq")

```


\subsubsection{Visualize the important explanatory factors for behavioral tolerance}


```{r visualing the pattern between behavioral Tol and Vig}
#TrialTimeGraph
BehavTolbyVig=visreg(BehavTolLM, scale="response", "ScBehavVig", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Behavioral Tolerance (cm/s/worm)")+
  xlab("Scaled behavioral vigor (cm/s)")+
  theme(text=element_text(size=22))
#Print the graph
print(BehavTolbyVig)
```


```{r visualing the pattern between behavioral tolerance and SMI, include=FALSE}
#SMI graph
BehavTolbySMI=visreg(BehavTolLM, scale="response", "ScResidPLSMI", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Behavioral Tolerance (cm/s)")+
  xlab("Scaled residual of Pre-infeciton mass index")+
  theme(text=element_text(size=22))
#Print the graph
print(BehavTolbySMI)
```

```{r visualing the pattern between behavioral tolerance and TisTol, include=FALSE}
#SMI graph
# BehavTolbyLength=visreg(BehavTolLM, scale="response", "ScRPLength", "Sex", partial=T, gg=TRUE)+
#   theme_classic()+
#   theme(legend.position="none")+
#   ylab("Behavioral Tolerance (cm/s)")+
#   xlab("Scaled length residual (mm)")+
#   theme(text=element_text(size=22))
# #Print the graph
# print(BehavTolbyLength)
```

```{r visualing the pattern between behavioral tolerance and Length, include=FALSE}
# #SMI graph
# BehavTolbyTisTol=visreg(BehavTolLM, scale="response", "ScTisTol", partial=T, gg=TRUE)+
#   theme_classic()+
#   theme(legend.position="none")+
#   ylab("Behavioral Tolerance (cm/s)")+
#   xlab("Scaled Tissue Tolerance (mm/mg/worm)")+
#   theme(text=element_text(size=22))
# #Print the graph
# print(BehavTolbyTisTol)
```

\subsubsection{Post-hoc analysis for behavioral tolerance by sex}

```{r linear model for post hoc behavorial tolerance by sex, include=FALSE}
#We have some outliers that make interpreting the results for behavioral tolerance a pain so were removing them from the analysis
 IndBehavI2<- IndBehavI %>%
  filter(fishID != c("49")) %>%
  filter(fishID != c("95")) %>%
  filter(fishID != c("73")) %>%
  filter(fishID != c("145")) 

IndBehavIF<- IndBehavI2 %>%
  filter(Sex == "F")

IndBehavIM<- IndBehavI2 %>%
  filter(Sex == "M")
#Fit a linear model for behavioral tolerance
#Note this is a linear mixed model because we have multiple measures per fish and therefore, need to account for non-independence between measures. 
BehavTolLMF<-glmmTMB(BehavTol~ScChSMI+ScResidPLSMI+ScVarvelBef+ScRPLength+ScBehavVig+Treatment+(1|BehavGroup), IndBehavIF)

BehavTolLMM<-glmmTMB(BehavTol~ScChSMI+ScResidPLSMI+ScVarvelBef+ScRPLength+ScBehavVig+Treatment+(1|BehavGroup), IndBehavIM)




#Summary to see the relationship of the variables. 
summary(BehavTolLMF)

summary(BehavTolLMM)

```


\subsection{What factors are important for host infection intensity over the course of infection and do is there any sexual variation in host infection intensity?}

\subsection{Visually inspection of the explanatory variables that will be used in the analyses}
```{r vsiaully inspecting covariates for the tolerance and vigor model, warning=FALSE}

pairs(~AUC2+Sex+ScPSMI+ScVarvelBef+ScBehavTol+ScBehavVig+PreLength+Treatment, lower.panel=panel.smooth, diag.panel=panel.hist, 
upper.panel=panel.cor, data=IndBehav8)

```

\subsubsection{Description, development, and fitting of linear model for the analysis}

We will use a linear model to analyze how infection intensity differs by sexual variation and other important host traits. Given each host only has one infection intensity measure, we do not need the fishID random effect used in previous models.

* Deterministic
 + $AUC_{det}$ = a + $b_{1}$Sex + $b_{2}$ScBehavVig + $b_{3}$ScVarVelBef + $b_{4}$ScResidPLSMI + $b_{5}$ScRPLength + $b_{6}$Sex:ScBehavVig + $b_{7}$Sex:ScResidPLSMI

* Stochastic
  + AUC ~ *N*($AUC_{det}$, $\sigma^{2}$) 

  
* Fixed
  + Sex 
  + Scaled behavioral vigor 
  + Scaled Pre-infection SMI
  + Scaled variance in velocity before infection 
  + Scaled Residuals of Length and Sex 
  + VIE treatment
  + Interaction between Sex and behavioral vigor
  + Interaction between sex and body condition
  
  
```{r linear model for Infection Intensity}
#Fit a linear model for behavioral tolerance
#Note this is a linear mixed model because we have multiple measures per fish and therefore, need to account for non-independence between measures. 
AUCLM<-glm(AUC2~Sex+ScBehavVig+ScBehavVig+ScVarvelBef+ScResidPLSMI+ScRPLength+Treatment+Sex:ScResidPLSMI, family=Gamma(link="log"), IndBehavI)

#Summary to see the relationship of the variables. 
summary(AUCLM)

```

\subsubsection{Validate that the model fits well and there are no problems}


```{r model validation for the AUC model, warning=FALSE}

#Using the check_model function from the perforamnce package to check the model validation

check_model(AUCLM)


#Using the Dharma package to check quantile residuals
#First simulating the quantile residuals
sim_residuals_AUCLM <-simulateResiduals(AUCLM, 1000)
#Plotting the quantile residuals to test how quantile residuals look
plot(sim_residuals_AUCLM) 
#Testing for dispersion
testDispersion(sim_residuals_AUCLM)

```


\subsubsection{Testing the significance of factors in our model}

```{r checking significance of fixed effects for AUC model, warning=FALSE}

summary(AUCLM)

```

\subsubsection{Visualize the important explanatory factors for infection intensity}


```{r visualing the pattern between Infection intensity and behav Vig, warning=FALSE}
#Behavioral Vigor graph
InfIntbyVig=visreg(AUCLM, scale="response", "ScBehavVig", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Infection intensity")+
  xlab("Scaled variance in velocity before infection")+
  theme(text=element_text(size=22))
#Print the graph
print(InfIntbyVig)
```


```{r visualing the pattern between Infection intensity and Variance in velocity, Warning=FALSE}
#Behavioral Vigor graph
InfIntbyLen=visreg(AUCLM, scale="response", "ScRPLength", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Infection intensity")+
  xlab("Scaled Residual length (mm)")+
  theme(text=element_text(size=22))
#Print the graph
print(InfIntbyLen)
```

```{r visualing the pattern between Infection intensity and SMI by sex, Warning=FALSE}
#Sex by SMI graph
InfIntbySex=visreg(AUCLM, scale="response", "Sex", partial=T, gg=TRUE)+
  theme_classic()+
  theme(legend.position="none")+
  ylab("Infection intensity")+
  xlab("Scaled body condition")+
  theme(text=element_text(size=22))
#Print the graph
print(InfIntbySex)
```

<!-- \subsection{What factors are important for the change of hosts behavior over fitness space and ifnection?} -->

<!-- \subsubsection{Description, development, and fitting of linear model for the analysis} -->

<!-- We will use a linear model to analyze how host total movement over fitness space differs by sexual variation and other important host traits. Given each host only has one total movement over fitness space measure, we do not need the fishID random effect used in previous models. -->

<!-- * Deterministic -->
<!--  + $PolyArea_{det}$ = a + $b_{1}$Sex + $b_{2}$ScPSMI + $b_{3}$ScVarVelBef + $b_{4}$ScBehavVig -->

<!-- * Stochastic -->
<!--   + PolyArea ~ *N*($PolyArea_{det}$, $\sigma^{2}$)  -->


<!-- * Fixed -->
<!--   + Sex  -->
<!--   + Scaled Pre-infection SMI -->
<!--   + Scaled variance in velocity before infection  -->
<!--   + Scaled behavioral vigor  -->


<!-- # ```{r poly area model, warning=FALSE, include=FALSE, echo =FALSE, eval = FALSE} -->
<!-- # -->
<!-- # IndBehavI <- IndBehavI %>% -->
<!-- #   na.omit(PolyArea) -->
<!-- # -->
<!-- # #Fit a linear model for behavioral tolerance -->
<!-- # #Note this is a linear mixed model because we have multiple measures per fish and therefore, need to account for non-independence between measures. -->
<!-- # PALM<-glm(PolyArea~ScVarvelBef+ScPSMI+Sex*ScBehavVig, family=Gamma(link="log"), IndBehavI) -->
<!-- # -->
<!-- # summary(IndBehavI$PolyArea) -->
<!-- # -->
<!-- # #Summary to see the relationship of the variables. -->
<!-- # summary(PALM) -->
<!-- # -->
<!-- # check_model(PALM) -->
<!-- # ``` -->
